{
  "hash": "0f2925fb92b279febe4d3ac6ca08d3da",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Introduction to Simulation Modeling\"\nsubtitle: \"for within-host infections\"\ndate: \"2024-07-17 14:04:37.69986\"\nauthor: \"[Andreas Handel](https://www.andreashandel.com)\"\nformat: \n  revealjs:\n    theme: default\n    css: \"./media/handelslides.css\"\n    transition: none\n    incremental: false\n    cap-location: bottom\n    self-contained: true\n    slide-number: true\n    show-slide-number: all\n    auto-stretch: true\n    smaller: true\nbibliography: ./media/SMICourse.bib\n---\n\n\n\n\n## Science needs data\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![[PhDComics](https://phdcomics.com/comics/archive.php?comicid=761)](./media/phd_scientificmethod.gif){fig-align='center' width=100%}\n:::\n:::\n\n\n\n\n\n## Experimental studies\n\n:::: {.columns}\n::: {.column width=\"50%\"}\n* The approach used in almost all bench/lab sciences.\n* Clinical trials in Public Health and Medicine.\n* Potentially most powerful because we have most control.\n* Not always possible.\n:::\n\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](./media/cartoon_rats.jpg){fig-align='center' width=80%}\n:::\n:::\n\n\n:::\n::::\n\n\n## Observational studies\n\n* Widely used in Public Health and other areas (e.g. Medicine, Sociology, Geology).\n* Not as powerful as experimental studies.\n* Often the only option.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Jim Borgman](./media/studies-produce-random-results.png){fig-align='center' width=70%}\n:::\n:::\n\n\n\n\n## Simulation/modeling studies\n\n* Computer models can represent a real system.\n* Simulated data is not as good as real data.\n* Often the only option.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![[xkcd.com](https://xkcd.com/1831/)](./media/xkcd_algorithm_help.png){fig-align='center' width=100%}\n:::\n:::\n\n\n\n\n\n## Modeling definition\n\n:::: {.columns}\n::: {.column width=\"50%\"}\n* The term __modeling__ usually means (in science) the description and analysis of a system using mathematical or computational models. \n* Many different types of modeling approaches exist. Simulation models are one type (with many subtypes).\n:::\n\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Handel et al 2020 NRI](./media/nri_review_fig2.png){fig-align='center' width=100%}\n:::\n:::\n\n\n:::\n::::\n\n\n\n\n\n## A way to classify models\n\n\n* __Phenomenological/non-mechanistic/heuristic/(statistical) models__\n  * Look at patterns in data\n  * Do not describe mechanisms leading to the data\n* __Mechanistic/process/simulation models__\n  * Try to represent simplified versions of mechanisms\n  * Can be used with and without data\n\n\n\n## Phenomenological models\n\n:::: {.columns}\n::: {.column width=\"50%\"}\n* You might be familiar with statistical models (that includes Machine Learning, AI, Deep Learning,...).\n* Most of those models are phenomenological/non-mechanistic (and static).\n* Those models are used extensively in all areas of science.\n* The main goal of these models is to understand data/patterns and make predictions.\n:::\n\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![[xkcd.com](https://xkcd.com/2048/)](./media/xkcd-curve_fitting.png){fig-align='center' width=70%}\n:::\n:::\n\n\n:::\n::::\n\n\n\n## Non-mechanistic model example\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Wu et al 2019 Nature Communications.](./media/wu_natcomm.png){fig-align='center' width=70%}\n:::\n:::\n\n\n\n\n## Non-mechanistic models - Advantages\n:::: {.columns}\n::: {.column width=\"50%\"}\n* Finding correlations/patterns is (relatively) simple.\n* Some models are very good at predicting (e.g. Netflix, Google Translate).\n* Sometimes we can go from correlation to causation.\n* We don't need to understand all the underlying mechanisms to get actionable insights.\n:::\n\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![[xkcd.com](https://www.xkcd.com/2289/)](./media/xkcd-scenario-forcasting.png){fig-align='center' width=100%}\n:::\n:::\n\n\n:::\n::::\n\n\n\n## Non-mechanistic models - Disadvantages\n\n:::: {.columns}\n::: {.column width=\"50%\"}\n* The jump from correlation to causation is always tricky (bias/confounding/systematic errors). \n* Even if we can assume a causal relation, we do not gain a lot of mechanistic insights or deep understanding of the system.\n:::\n\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![[xkcd.com](https://xkcd.com/1838/)](./media/xkcd-machine_learning.png){fig-align='center' width=80%}\n:::\n:::\n\n\n:::\n::::\n\n\n\n## Mechanistic models\n\n:::: {.columns}\n::: {.column width=\"50%\"}\n* We formulate explicit mechanisms/processes driving the system  dynamics.\n* This is done using mathematical equations (often ordinary differential equations), or computer rules.\n* Also called __systems/dynamic(al)/ (micro)simulation/process/ mathematical/ODE/... models__.\n:::\n\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Handel et al 2020 NRI](./media/nri_review_fig3.png){fig-align='center' width=90%}\n:::\n:::\n\n\n:::\n::::\n\n\n## Mechanistic model example \n\n:::: {.columns}\n::: {.column width=\"40%\"}\n$$\n\\begin{aligned}\n\\dot V & = rV-kVT^*\\\\\n\\dot P & = fV - dP \\\\\n\\dot T & = -aPT \\\\\n\\dot T^* & = aPT + gT^*\n\\end{aligned}\n$$\n:::\n\n::: {.column width=\"60%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Handel & Antia 2008 J Vir](./media/handel_jvir.png){fig-align='center' width=100%}\n:::\n:::\n\n\n:::\n::::\n\n\n\n\n## Mechanistic models - Advantages\n<div style=\"float: left; width: 50%;\">\n* We get a potentially deeper, mechanistic understanding of the system.\n* We know exactly how each component affects the others in our model.\n</div>\n\n<div style=\"float: right; width: 50%;\">\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](./media/nri_review_fig3a.png){fig-align='center' width=90%}\n:::\n:::\n\n\n</div>\n\n\n## Mechanistic models - Disadvantages\n<div style=\"float: left; width: 50%;\">\n* We need to know (or assume) something about the mechanisms driving our system to build a mechanistic model.\n* If our assumptions/model are wrong, the \"insights\" we gain from the model are spurious.\n</div>\n\n<div style=\"float: right; width: 50%;\">\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](./media/nri_review_fig3a.png){fig-align='center' width=90%}\n:::\n:::\n\n\n</div>\n\n\n## Non-mechanistic vs Mechanistic models \n* Non-mechanistic models (e.g. regression models, machine learning) are useful to see if we can find patterns in our data and possibly predict, without necessarily trying to understand the mechanisms.\n* Mechanistic models are useful if we want to study the mechanism(s) by which observed patterns arise.\n\n**Ideally, you want to have both in your 'toolbox'.**    \n\n\n\n## Simulation models\n* We will focus on __mechanistic simulation models.__\n* The hallmark of such models is that they explicitly (generally in a simplified manner) model processes occuring in a system. \n\n\n## Simulation modeling uses\n* Weather forecasting.\n* Simulations of a power plant or other man-made system.\n* Predicting the economy.\n* Infectious disease transmission.\n* Immune response modeling.\n* ...\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![www.gocomics.com/nonsequitur](./media/ns_useofpredictions.gif){fig-align='center' width=100%}\n:::\n:::\n\n\n\n\n## Real-world examples\nUsing a TB model to explore/predict cytokine-based interventions (Wigginton and Kirschner, 2001 J Imm).\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](./media/tbkirschner.png){fig-align='center' width=80%}\n:::\n:::\n\n\n\n\n\n## Real-world examples\nTargeted antiviral prophylaxis against an influenza pandemic (Germann et al 2006 PNAS).\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](./media/iraflufigure.jpg){fig-align='center' width=50%}\n:::\n:::\n\n\n\n\n\n## Within-host and between-host modeling\n\nWithin-host/individual level | Between-host/population level |\n---------- | ---------- |\nSpread inside a host (virology, microbiology, immunology) | Spread on the population level (ecology, epidemiology) |\nPopulations of pathogens & immune response components | Populations of hosts (humans, animals) |\nAcute/Persistent (e.g. Flu/TB) | Epidemic/Endemic (e.g. Flu/TB) |\nUsually (but not always) explicit modeling of pathogen | Often, but not always, no explicit modeling of pathogen |\n\nThe same types of simulation models are often used on both scales.\n\n\n## Population level modeling history\n\n* 1766 - Bernoulli \"An attempt at a new analysis of the mortality\ncaused by smallpox and of the advantages of inoculation to\nprevent it\" (see Bernoulli & Blower 2004 Rev Med Vir)\n* 1911 – Ross \"The Prevention of Malaria\"\n* 1920s – Lotka & Volterra \"Predator-Prey Models\"\n* 1926/27 - McKendrick & Kermack \"Epidemic/outbreak models\"\n* 1970s/80s – Anderson & May\n* Lot’s of activity since then\n* See also Bacaër 2011 \"A Short History of Mathematical Population Dynamics\"\n\n\n## Within-host modeling history\n\n* The field of within-host modeling is somewhat recent, with early attempts in the 70s and 80s and a strong increase since then.\n* HIV garnered a lot of attention starting in the late 80s, some influential work happened in the early 90s.\n* Overall, within-host models are still less advanced compared to between-host modeling, but it's rapidly growing.\n\n\n\n## A simple simulation model\n* We'll start with a very simple model, a population of entities (pathogens/immune cells/humans/animals) that grow or die.\n* We'll implement the model as a discrete time equation, given by:\n\n$$\nP_{t+dt} = P_t + dt ( g P_t - d_P P_t )\n$$\n\n* $P_t$ are the number of pathogens in the population at current time $t$, $dt$ is some time step and $P_{t+dt}$ is the number of pathogens in the future after that time step has been taken.\n* The processes/mechanisms modeled are growth at rate $g$ and death at rate $d_P$.\n\n\n## A simple simulation model\n* If we started with 100 individuals (pathogens) at time t=0, had a growth rate of 12 and death rate of 2 (per some time unit, e.g. days or weeks or years), and took time steps of $dt=1$, how many individual would we have after 1,2,3... time units?\n* Why do we multiply by the time step, _dt_?\n\n$$\nP_{t+dt} = P_t + dt ( g P_t - d_P P_t )\n$$\n\n## A simple simulation model - variant 1\nOriginal:\n\n$$\nP_{t+dt} = P_t + dt ( g P_t - d_P P_t )\n$$\nAlternative:\n\n$$\nP_{t+dt} = P_t + dt ( g - d_P P_t )\n$$\nWhat's the difference? Is this a good model?\n\n\n## A simple simulation model - variant 2\nOriginal:\n\n$$\nP_{t+dt} = P_t + dt ( g P_t - d_P P_t )\n$$\nAlternative:\n\n$$\nP_{t+dt} = P_t + dt ( g P_t - d_P)\n$$\n\nWhat's the difference? Is this a good model?\n\n## Discrete time models\n\n$$\nP_{t+dt} = P_t + dt ( g P_t - d_P P_t )\n$$\n\n* The model above is updated in discrete time steps (to be chosen by the modeler).\n* Good for systems where there is a \"natural\"\" time step. E.g. some animals always give birth in spring or some bacteria divide at specific times.\n* Used in complex individual based models for computational reasons.\n* For compartmental models where we track the total populations (instead of individuals), continuous-time models are more common. They are usually formulated as ordinary differential equations (ODE).\n* If the time-step becomes small, a discrete-time model approaches a continuous-time model.\n\n\n## Continuous time models\n\nDiscrete:\n\n$$\nP_{t+dt} = P_t + dt ( g P_t - d_P P_t )\n$$\nRe-write:\n\n$$\n\\frac{P_{t+dt} - P_t}{dt} =  g P_t - d_P P_t \n$$\n\nContinuous:\n$$\n\\frac{dP}{dt}  = gP - d_P P\n$$\n\n* If we simulate a continuous time model, the computer uses a smart discrete time-step approximation.\n\n## Some notation\nThe following are 3 equivalent ways of writing the differential equation:\n\n$$\n\\begin{aligned}\n\\frac{dP(t)}{dt}  &= gP(t) - d_P P(t) \\\\\n\\frac{dP}{dt}  &= gP - d_P P \\\\\n\\dot{P}  &= gP - d_P P \\\\\n\\end{aligned}\n$$\nWe will use the 'dot notation'.\n\n\n## Some terminology\n\n$$\n\\dot{P}  = gP - d_P P\n$$\n\n* The left side is the change in time of the indicated variable.\n* Each term on the right side represents a (often simplified/abstracted) biological process/mechanism.\n* Any positive term on the right side is an inflow and leads to an increase of the indicated variable.\n* Any negative term on the right side is an outflow and leads to a decrease of the indicated variable.\n\n\n## Extending the model \n\n$$\n\\dot{P}  = gP - d_P P\n$$\n\nFor different values of the parameters _g_ and $d_P$, what broad types of dynamics/outcomes can we get from this model?  \n\n\n## Extending the model \n\n$$\n\\dot{P}  = gP - d_P P\n$$\n\nHow can we extend the model to get growth that levels off as we reach some high level of $P$?\n\n\n## Model with saturating growth \n$$\n\\dot{P}  = gP(1-\\frac{P}{P_{max}}) - d_P P\n$$\n\n* We changed the birth process from exponential/unlimited growth to saturating growth. $P_{max}$ is the level of $P$ at which the growth term is zero. \n* If $P > P_{max}$, the growth term is negative. \n* The population settles down at a level where the growth balances the decay, i.e. when $gP(1-\\frac{P}{P_{max}}) = d_P P$.\n\n\n## Adding a second variable\n\n* A single variable model is 'boring'.\n* The interesting stuff happens if we have multiple compartments/variables that interact.\n* Let's introduce a second variable.\n* Let's assume that _P_ is a population of some bacteria (but could also be some animal), which gets attacked and consumed by some predator, e.g. the immune system or another animal. We'll pick the letter _H_ for the predator (any label is fine). \n\n\n## Adding a second variable\n$$\n\\begin{aligned}\n\\dot{P} & = gP(1-\\frac{P}{P_{max}}) - d_P P \\ \\pm \\ ?\\\\\n\\dot{H} & = ?\n\\end{aligned}\n$$\n\n* The predator attacks/eats the prey. What process could we add to the _P_-equation to describe this?\n\n## Adding a second variable\n$$\n\\begin{aligned}\n\\dot{P} & = gP(1-\\frac{P}{P_{max}}) - d_P P - kPH\\\\\n\\dot{H} & = ?\n\\end{aligned}\n$$\n\n* The more _P_ there is, the more the predator will grow, e.g. by eating _P_ or by receiving growth signals. \n* What term could we write down for the growth dynamics of _H_?\n* Finally, _H_ individuals have some life-span after which they die. How can we model this?\n\n## Predator-prey model\n\nThe model we just built is a version of the well-studied predator-prey model from ecology.\n$$\n\\begin{aligned}\n\\dot{P} & = g_P P(1-\\frac{P}{P_{max}}) - d_P P - kPH\\\\\n\\dot{H} & = g_H P H - d_H H\n\\end{aligned}\n$$\n\nThe discrete-time version of the model is:\n$$\n\\begin{aligned}\nP_{t+dt} & = P_t + dt(g_P P_t(1-\\frac{P_t}{P_{max}}) - d_P P_t - kP_tH_t)\\\\\nH_{t+dt} & = H_t + dt( g_H P_t H_t - d_H H_t)\n\\end{aligned}\n$$\n\n\n## Bacteria and immune response model\n\nThe names of the variables and parameters are arbitrary. If we think of bacteria and the immune response, we might name them _B_ and _I_ instead.\n\n$$\n\\begin{aligned}\n\\dot{B} & = g B(1-\\frac{B}{B_{max}}) - d_B B - kBI\\\\\n\\dot{I} & = r BI - d_I I\n\\end{aligned}\n$$\n$$\n\\begin{aligned}\nB_{t+dt} & = B_t + dt(g B_t(1-\\frac{B_t}{B_{max}}) - d_B B_t - k B_t I_t)\\\\\nI_{t+dt} & = I_t + dt( r B_t I_t - d_I I_t)\n\\end{aligned}\n$$\n\n\n\n## Graphical model representation\n\n* It is important to go back and forth between words, diagrams, equations.\n* Diagrams specify a model somewhat, but not completely. The diagram below could be implemented as ODEs or discrete time or stochastic models.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](./media/nri_review_fig3a.png){fig-align='center' width=80%}\n:::\n:::\n\n\n\n\n\n## Model exploration\n<div style=\"float: left; width: 50%;\">\n* We could analyze the model behavior with 'pencil and paper' (or some software, e.g. Mathematica/Maxima). This only works for simple models. \n* We could analyze the model behavior by simulating it.\n* To simulate, we need to implement the model on a computer, specify starting (initial) conditions for all variables and values for all model parameters.\n* We'll do those explorations shortly.\n</div>\n\n<div style=\"float: right; width: 50%;\">\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Handel et al 2020 NRI](./media/nri_review_fig3.png){fig-align='center' width=100%}\n:::\n:::\n\n\n</div>\n\n\n## Homework\n\n* If you haven't already, install DSAIRM and take a look at the _Basic Virus Model_ and _Basic Bacteria Model_ apps. \n* Start looking at and going through the \"What to do\" tasks. You can try yourself first (better for learning), or look at the solutions right away (only suggested if you feel completely lost).\n* Take an especially close look at the solution for task 6 in the _Basic Bacteria_ app, we will use a similar approach tomorrow.\n* Links to solution files are in the schedule of the class website. \n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}