{
  "hash": "d3b83ad589526f45dd27c11451ee81ef",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Fitting and multi-scale modeling example\"\ndate: today\nauthor: \"[Andreas Handel](https://www.andreashandel.com)\"\nformat: \n  revealjs:\n    theme: default\n    css: \"./media/handelslides.css\"\n    transition: none\n    incremental: false\n    cap-location: bottom\n    self-contained: true\n    slide-number: true\n    show-slide-number: all\n    auto-stretch: true\n    smaller: false\n---\n\n\n\n\n# Multi-scale models\n\n\n## Introduction \n* Infectious diseases operate on different temporal and spatial scales. \n* Building models that connect scales can allow one to answer new questions.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Handel & Rohani 2015 PTB](./media/multiscale_fig.png){fig-align='center' width=90%}\n:::\n:::\n\n\n\n\n## Ways to model interactions across scales\n* Static: A within-host model is analyzed/simulated. Results are being fed into a between-host model, which is subsequently being run.\n* Dynamic: A within-host model is being simulated inside a between-host model. Requires an ABM for the between-host model, each agent has its own infection model running.\n\n\n\n\n\n## Simple example model\n* It is easiest to discuss multi-scale models in the context of an example. \n\n*  Let's consider the dynamics of an acute viral infection (e.g. influenza) at the within-host and the population level. \n\n## Within-host model\nAt the within host level, we can start with the basic virus model.\n\n$$\n\\begin{aligned}\n\\dot{U} & =  n - d_UU - bUV \\\\\n\\dot{I} & =  bUV - d_I I \\\\     \n\\dot{V} & =  pI - d_V V -  gb UV \\\\\n\\end{aligned}\n$$\n\n## Between-host model\n* At the population level, we'll look at the standard SIR model, with compartments being susceptible, infected and infectious, and recovered. \n* To avoid confusion, we give all the parameters on the population level model Greek letters.\n\n$$\n\\begin{aligned}\n\\dot S & = \\nu - \\mu S - \\beta SI   \\\\ \n\\dot I & = \\beta S I - \\gamma I - \\mu I \\\\\n\\dot R & = \\gamma I  - \\mu R  \\\\\n\\end{aligned}\n$$\n\n\n## Linking models {.smaller}\n* Assume transmission rate is linked to virus load through some function that maps virus to between-host transmission $\\beta = f(V)$.\n\n$$\n\\begin{aligned}\n\\dot S & = \\nu - \\mu S - \\mathbf{f(V)} SI   \\\\ \n\\dot I & = \\mathbf{f(V)} S I - \\gamma I - \\mu I \\\\\n\\dot R & = \\gamma I  - \\mu R  \\\\\n\\end{aligned}\n$$\n\n$$\n\\begin{aligned}\n\\dot{U} & =  n - d_UU - bUV \\\\\n\\dot{I} & =  bUV - d_I I \\\\     \n\\dot{ \\mathbf{V} } & =  pI - d_V V -  gb UV \\\\\n\\end{aligned}\n$$\n\nNow the between-host model is connected to the within-host model through the variable $V$. \n\n\n## Ways to link the scales/models\n\n* For a chronic infection model, we can compute virus at steady state ($V_s$) as function of model parameters. \n\n$$\\beta = kV_s$$ \n\n$$V_s = \\frac{n(p-d_Ig)}{d_Id_V}-\\frac{d_U}{b}$$ \n\n* Changes in the within-host parameters now impact the between-host dynamics.\n\n## Ways to link the scales/models\n\n* For an acute infection model, we could assume transmission is proportional to total virus load.\n\n$$\n\\beta = k \\log \\left( \\int_0^D V(t) dt \\right)\n$$\n\n* Again, changes of the within-host parameters impact the between-host dynamics. But we don't have an explicit mathematical expression.\n\n\n## Using the linked models to answer a question \n* We could now answer questions such as: Does increased virus infection rate (parameter $b$) lead to a larger outbreak on the population level? \n\n* For a chronic infection, we can see it from the equation: $$V = \\frac{n(p-d_Ig)}{d_Id_V}-\\frac{d_U}{b}$$ \n* For an acute infection, we would need to run simulations.\n\n## Other ways to link the scales/models {.smaller}\n\n* We could also assume that the duration of the infectious period ($1/\\gamma$) is determined by the time at which $V$ in the within host model drops below a certain level (e.g. 1 virion).\n* To investigate this:\n  - Set within-host model parameters. Run model. Determine time at which $V<1$ from time-series. \n  - Use that time as $1/\\gamma$ in the between-host model.\n\n$$\n\\begin{aligned}\n\\dot S & = \\nu - \\mu S - \\beta SI   \\\\ \n\\dot I & = \\beta S I - \\gamma I - \\mu I \\\\\n\\dot R & = \\gamma I  - \\mu R  \\\\\n\\end{aligned}\n$$\n\n\n## Closing the loop\n\n* So far, we assumed that the lower scale (within-host) affects the higher scale (between-host).\n* One could also consider the population level dynamics to impact the within-host level. E.g. if we had a new (flu) strain spreading on the population level which can partially avoid pre-existing immunity, it might impact the within-host dynamics.\n* It gets complicated. One either needs to break down the pieces and look at them individually, or put them all in one large simulation.\n\n\n# Fitting mechanistic models to data\n\n\n## Model fitting\n* We build models based on what we assume/know goes on in a specific system.\n* We can use models to explore and make predictions.\n* At some point, we need to bring our model results in contact with data to see how our model performs.\n* Ideally, the whole process is iterative.  \n* Main uses of model fitting is to test hypotheses and estimate parameters.\n\n\n## Hypothesis testing with non-mechanistic models\n* We usually test hypotheses by collecting data and performing statistical tests to see if there is a pattern (H1) or not (H0). \n* The statistical tests can discriminate between no pattern and some kind of pattern/correlation. \n* If data was collected properly, one can often conclude that there is a causal link. But one can't say much about the mechanisms leading to the observed patterns. \n\n\n## Hypothesis testing with mechanistic models\n* With mechanistic simulation models, we can directly __test hypotheses/mechanisms:__ We can formulate different models, each representing a set of hypotheses/mechanisms. The quality of fit of each model to the date lends support to specific models/mechanisms.\n* The mechanism(s) of the best fitting model are more likely to be correct than those of the less good fitting models.\n\n\n## Model fitting example \n* Investigate the mechanism of drug action of neuraminidase inhibitors against influenza.\n\n* The Question: What is the mechanism of action of neuraminidase inhibitors, is it reducing virus production of infected cells or infection of uninfected cells? \n\n* The approach: build models for each mechanism/hypothesis, fit to data and evaluate.\n\n\n## Model/Hypothesis 1\n\nNeuraminidase reduces infection rate of uninfected cells.\n\n$$\n\\begin{aligned}\n\\dot{U} & =  - b{\\bf(1-f)}UV \\\\\n\\dot{I} & =  b{\\bf(1-f)}UV - d_I I \\\\     \n\\dot{V} & =  pI - d_V V -  gb{\\bf(1-f)} UV \\\\\n\\end{aligned}\n$$\n\n## Model/Hypothesis 2\n\nNeuraminidase reduces rate of virus production by infected cells.\n\n$$\n\\begin{aligned}\n\\dot{U} & =  - bUV \\\\\n\\dot{I} & =  bUV - d_I I \\\\     \n\\dot{V} & =  p{\\bf (1-e)}I - d_V V -  gb UV \\\\\n\\end{aligned}\n$$\n\n\n\n\n## Model fits\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Handel et al 2020 NRI](./media/nri_review_fig4b.png){fig-align='center' width=75%}\n:::\n:::\n\n\n\n\n\n## Parameter estimates {.smaller}\n* By fitting models, we can also __estimate biologically meaningful parameters.__ \n* The parameters in our models often represent important biological quantities, fitting returns estimates for the parameter values.\n* For the example, the best-fit estimate e=0.98 means the drug reduces virus production by 98%.\n\n$$\n\\begin{aligned}\n\\dot{U} & =  - bUV \\\\\n\\dot{I} & =  bUV - d_I I \\\\     \n\\dot{V} & =  p{\\bf (1-e)}I - d_V V -  gb UV \\\\\n\\end{aligned}\n$$\n\n## Parameter estimates\n* One can estimate parameters using just a single model. This allows one to test some mechanisms, e.g. we could use one of the models we just looked at and ask if the drug has an effect (e>0) or not ($e\\approx 0$). Fitting a single model and looking at the value of $e$ could answer this. \n* To test more complex hypotheses/mechanisms, one often needs several distinct models. If one of the tested models is deemed a good approximation of the real system, the estimates for its parameters can be consider meaningful.\n\n\n## Fitting comments\n* Fitting mechanistic models is conceptually the same as fitting regression models, but technically more challenging.\n* If a non-mechanistic model doesn't fit well, we mainly just learned that we need a better model.\n* If a mechanistic model that was built based on our best knowledge doesn't fit well, we have learned something useful!\n\n\n## Fitting comments\n\n<div style=\"float: left; width: 50%;\">\n* If a model is _best_ among a group of models, it can still be _bad_.\n* Complex models with many parameters can provide good fits for spurious reasons. \n* It is important to keep models simple to prevent overfitting.\n</div>\n\n<div style=\"float: right; width: 50%;\">\n_With four parameters I can fit an elephant, and with five I can make him wiggle his trunk._\n\nJohn von Neumann\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![https://bit.ly/31UB3v9](./media/elephant.png){fig-align='center' width=100%}\n:::\n:::\n\n\n</div>\n\n\n\n## Fitting - practice\n* The _Influenza Drug model_ in DSAIRM shows the example we just went through. It doesn't go into details of fitting.\n* The apps in the _Model fitting_ section of DSAIRM teach some concepts of model fitting.\n\n\n# A worked example\n\n## Setup\n\n* Let's do a pretend modeling project covering the topics we just discussed.\n* Our question is: What is the population-level impact of treating individuals at various times post infection with neuraminidase inhibitors?\n\n\n\n## Hands-on exercise 1 {.smaller}\n\n* Use the _Influenza Drug Model_ app, fit model 2 to the data and determine the best-fitting parameter values.\n* Write code that loops over the treatment starting time, _txstart_, (say from 0.1 days to 2 days), and for each value of _txstart_, runs the `simulate_virusandtx_ode` model and computes the log of the total virus load: $$V_{tot} = \\log \\left( \\int_0^D V(t) dt \\right)$$\n* All other model parameters should be at the estimated best fit values.\n\n## Hands-on exercise 2 {.smaller}\n\n* Install the 'DSAIDE' package. \n* Write some code that loops over the parameter $\\beta$, runs the `simulate_SIR_model_ode` model and computes total outbreak size for each value of $\\beta$.\n* Assume that $\\beta$ is proportional to the log of the within-host virus load: $$\\beta = \\beta_0 V_{tot}/V_{max}$$ \n* $V_{max}$ is the total virus load in the absence of treatment. You can get that by running the within-host model for some _txstart_ value that's the same as the final time. \n\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}